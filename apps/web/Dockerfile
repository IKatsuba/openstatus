FROM node:20 as builder

ARG RAILWAY_DOCKERFILE_PATH
ARG TINY_BIRD_API_KEY
ARG RESEND_API_KEY
ARG GCP_PROJECT_ID
ARG GCP_LOCATION
ARG GCP_CLIENT_EMAIL
ARG GCP_PRIVATE_KEY
ARG CRON_SECRET
ARG EXTERNAL_API_URL
ARG PLAIN_API_KEY
ARG PAGERDUTY_APP_ID
ARG CHECKER_API_URL
ARG QSTASH_CURRENT_SIGNING_KEY
ARG QSTASH_NEXT_SIGNING_KEY
ARG QSTASH_TOKEN
ARG QSTASH_URL
ARG NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
ARG STRIPE_SECRET_KEY
ARG STRIPE_WEBHOOK_SECRET_KEY
ARG UNKEY_API_ID
ARG UNKEY_TOKEN
ARG DATABASE_URL
ARG UPSTASH_REDIS_REST_TOKEN
ARG UPSTASH_REDIS_REST_URL
ARG PROJECT_ID_VERCEL
ARG TEAM_ID_VERCEL
ARG NEXT_PUBLIC_URL
ARG VERCEL_AUTH_BEARER_TOKEN
ARG AUTH_SECRET
ARG AUTH_TRUST_HOST
ARG AUTH_GITHUB_ID
ARG AUTH_GITHUB_SECRET
ARG NEXTAUTH_URL
ARG NEXTAUTH_URL_INTERNAL
ARG RAILWAY_PROJECT_NAME

WORKDIR /app

COPY . .

RUN npm install -g pnpm
RUN pnpm install &&\
    pnpm run build

FROM node:20-alpine as runner

WORKDIR /app

ENV NODE_ENV=production

COPY --from=builder /app/apps/web/public ./apps/web/public
COPY --from=builder /app/apps/web/.next/standalone ./
COPY --from=builder /app/apps/web/.next/static ./apps/web/.next/static

EXPOSE 3000

CMD HOSTNAME="0.0.0.0" node apps/web/server.js
